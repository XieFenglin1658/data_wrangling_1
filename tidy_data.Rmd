---
title: "tidy_data"
output: github_document
---
```{r setup}
library(tidyverse)
library(readxl)
library(haven)
```

## `pivot_longer`

load the PULSE data

```{r}
pulse_data =
  haven::read_sas("data/public_pulse_data.sas7bdat") |> 
  janitor::clean_names()
```

wide format to longer format..
##I think: 让数据easy to manipulate,more tidy

##大家前缀都一样，则为了更方便read data，可以将前缀去掉，使用`names_prefix = `

```{r}
pulse_data_tidy =
  pulse_data |>
  pivot_longer(
    col = bdi_score_bl:bdi_score_12m,
    names_to = "visit",
    names_prefix = "bdi_score_",
    values_to = "bdi"
  )
```

rewrite, combine, and extend(to add a mutate)
```{r}
pulse_data =
  haven::read_sas("data/public_pulse_data.sas7bdat") |> 
  janitor::clean_names() |>
  pivot_longer(
    col = bdi_score_bl:bdi_score_12m,
    names_to = "visit",
    names_prefix = "bdi_score_",
    values_to = "bdi"
  ) |>
  relocate(id, visit) |> 
  mutate(visit = recode(visit, "bl" = "00m"))
  
```

sorry,that's pivot_longer, not pivot_wider! just need to change the commit!

Do one more example
##这里的gd_time只有两个，tidy的优势不明显，但是若有很多个，pivot_longer的优势就更明显了
```{r}
litters_df =
  read_csv("data/FAS_litters.csv", na = c("NA", ".", "")) |> 
  janitor::clean_names() |> 
  pivot_longer(
    cols = gd0_weight:gd18_weight,
    names_to = "gd_time",
    values_to = "weight"
  ) |> 
  mutate(gd_time = case_match(gd_time, "gd0_weight" ~ 0, "gd18_weight" ~ 18))
```


## `pivot_wider`
##I think : 让数据easy to read，readability.
##kable生成一个table，在knit之后
make up some data

```{r}
analysis_result =
  tibble(
    group = c("treatment", "treatment", "control", "control"),
    time = c("pre", "post","pre", "post"),
    mean = c(4, 8, 3.5, 4)
  )

analysis_result |> 
  pivot_wider(
    names_from = "time",
    values_from = "mean"
  ) |> 
  knitr::kable()
```
 

## Bind tables

```{r}
fellowship_ring =
  read_excel("data/LotR_Words.xlsx", range ="B3:D6") |> 
  mutate(movie = "fellowship_ting")

two_towers =
  read_excel("data/LotR_Words.xlsx", range ="F3:H6") |> 
  mutate(movie = "two_towers")

return_king =
  read_excel("data/LotR_Words.xlsx", range ="J3:L6") |> 
  mutate(movie = "return_king")

lotr_df =
  bind_rows(fellowship_ring, two_towers, return_king) |>
  janitor::clean_names() |> 
  pivot_longer(
    cols = female:male,
    names_to = "sex",
    values_to = "words"
  ) |> 
  relocate(movie) |> 
  mutate(race = str_to_lower(race))
```

##要把所有在同一种类的variable combine成一个variable才算tidy enough吗
##似乎不是，gd0_weight和gd18_weight这两个variable不仅包括了weight还包括了time (0和18)，所以需要pivot_longer,其余的bdi_score/male female也是一样，都是因为one variable contain more than one information which is not tidy enough, technically.

##下面重听

## Join FAS datasets

import `litters`datasets

##group这个variable中包含variable level(con\mod\low)和group number(7&8)两个信息，为了让数据更tidy，we need to `seperate` it into two variables. 
##`sep = 3`-- how to split the variable--代表在第三个字符处分开group这个variable（string),若该string is not clean,则需要先做其他操作,如`case_match`，不然无法使用`sep`

```{r}
litters_df =
  read_csv("data/FAS_litters.csv", na = c("NA", ".", "")) |> 
  janitor::clean_names() |> 
  mutate(wt_gain = gd18_weight - gd0_weight) |> 
  separate(
    group, into = c("dose", "day_of_treatment"), sep = 3
  )
```

Import `pup`datasets

```{r}
pups_df =
  read_csv("data/FAS_pups.csv", skip = 3, na = c("NA", ".", "")) |> 
  janitor::clean_names() |> 
  mutate(
    sex = case_match(
      sex,
      1 ~ "male",
      2 ~ "female"
    )
  )
```

join the datasets!
##不要让R帮你决定join_by什么，最好是自己写下来`by = `，方便以后自己查看，别人查看代码也方便

##若不确定data是啥样的，可以先用`full_join`

##left_join是如何工作的,pup中没有dose这个variable，但是fas_df中有关dose的数据又多于litters中的，这是怎么回事？

```{r}
fas_df =
  left_join(pups_df, litters_df, by = "litter_number") |> 
  relocate(litter_number, dose, day_of_treatment)


```


